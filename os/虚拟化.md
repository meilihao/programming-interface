# 虚拟化
虚拟化是一种资源管理技术.

分类方式:
- 软硬件实现

    - 软件虚拟化: qemu, 性能较弱
    - 硬件虚拟化: intel vt
- 是否需要修改客户机内核

    - 半虚拟化 : 客户机需要更改系统内核才得以实现虚拟化, 比如virtio,xen
    - 全虚拟化 : 不需要修改客户机内核
- 虚拟层是直接位于硬件之上还是hostos上
    1. 主机级虚拟化
        1. Type 1类型 : 裸机架构虚拟化, 它是运行在服务器硬件之上, 比如阿里云的神龙架构(X-Dragon), 微软的Hyper-v、VMware vSphere的ESXi和Citrix的XenServer
        1. Type 2类型 : HostOS构虚拟化层, 它是运行在HostOS之上,  比如KVM, VMware Workstion, Oracle VM VirtualBox
    1. 容器级虚拟化, 比如docker

> 提供虚拟化的软件层称为 Hypervisor

> kvm因为其独特的设计是横跨在Type 1和Type 2之间的.

Linux查看机器是否虚拟机:
```sh
$ dmesg |grep -i virtual
[    0.029424] Booting paravirtualized kernel on KVM # 物理机是`Booting paravirtualized kernel on bare hardware`
[    0.660281] systemd[1]: Detected virtualization kvm.
# virt-what
# systemd-detect-virt
# cat /sys/class/dmi/id/sys_vendor
```

# kvm
kvm(Kernel-based Virtual Machine), 是基于内核的虚拟化, 是采用硬件虚拟化(intel vt/amd v)的全虚拟化解决方案.

![kvm和qemu架构](/misc/img/os/virt/xLEwiKumTSA5HvW.png)

> QEMU可以不依靠KVM模拟完整的guest系统，但性能很差.

> 一个kvm vm对应一个linux进程, 每个vCPU是该进程下的一个线程, 还有单独的io处理线程. 因此可通过linux的各种进程调度来实现不同vm的权限限定, 优先级等.

> kvm vm看到的硬件是qemu模拟的(不包括VT-d透传的设备), 由qemu截获并转换为对实际设备的驱动操作.

![Xen, KVM, QEMU架构对比](/misc/img/os/virt/c5TkF1QHGyvS3dz.png)

相比于Xen架构，KVM架构有三大的优势：
1. 同等硬件资源环境下，KVM的性能表现更优
1. KVM架构天然的继承Linux内核更新迭代带来的系统优化，几乎不费力气，就完成了一次功能升级, 但对于Xen架构来说，每一次Xen Hypervisor内核或者Linux内核版本升级，Xen架构需要同步优化联调Xen Hypervisor内核和特权域(基于Linux的内核)，才能实现整个虚拟化内核的升级
1. 目前云厂商均使用kvm, 是趋势. 

![VirtIO](/misc/img/os/virt/WqYaSrQ3C8eEKuh.png)

## kvm特性
1. 内存管理

    vm的"物理内存"就是对应宿主机进程的虚拟内存.
    vm自身内存访问落实到真实的宿主机的物理内存的机制叫影子页表(shadow page table), kvm Hypervisor为每个vm准备一份影子页表, 与vm自身页表建立一一对应关系. 因为性能原因, 目前影子页表的映射转换(`GPA->HPA`)已由硬件完成(intel ept/amd npt), 默认开启.

    > - kvm内存映射转换: GVA(guest virtual address, 客户机虚拟地址)->GPA(guest physical address)->HVA(host virtual address, 宿主机虚拟地址)->HPA(host physical address).

    > - vm自身页表描述的是GVA->GPA; 影子页表描述的是GPA->HPA.
1. kvm image格式

    确切的说是qemu的功能.
    kvm的image格式是qcow2, 支持快照(包括多级快照), 压缩和加密.
1. 实时迁移

    在宿主机间迁移vm而不中断服务.
1. 设备驱动程序

    - 支持半虚拟化的驱动程序(virtio标准)来提高io性能.
    - 支持intel VT-d, 通过将宿主机的pci总线上的设备透传(pass-through)给vm.
1. 性能和可伸缩性

    继承了linux的性能和可伸缩性
