# 分布式存储
特点:
1. 可扩展
1. 低成本
1. 高性能

    维度: 吞吐量和访问延迟
1. 易用
1. 高可用

难点: 数据和状态的持久化, 要求在自动迁移,自动容错,并发读写的过程中保证数据的一致性.
核心相关领域: 分布式系统, 分布式DB

相关内容:
1. 数据分布
1. 多副本一致性
1. 容错
1. 负载均衡
1. 事务与并发控制
1. 易用性
1. 解压缩

分布式存储系统分类:
1. 分布式文件系统
    
    以对象(图片, 视频等非结构化数据)的形式组织, 对象间没有关联, 该类数据被称为blob(binary large object, 二进制大对象).

    比如Facebook haystack, taobao file system(TFS) 
1. 分布式kv系统

    amazon dynamo, tabao tair, tikv
1. 分布式表格系统

    google bigtable, amazon dynamodb
1. 分布式数据库

    google spanner, tidb, oceanbase

> 分布式表格系统主要针对单表操作, 不支持一些特别复杂的操作: 多表关联, 嵌套子查询等.

## 对象存储
对象 = 数据 + 元数据

## 纠删码(erasure code)
纠删码是一种恢复丢失和损坏数据的数学算法，目前，纠删码技术在分布式存储系统中的应用主要有三类:
- 阵列纠删码（Array Code: RAID5、RAID6等）
- RS(Reed-Solomon)里德-所罗门类纠删码
- LDPC(LowDensity Parity Check Code)低密度奇偶校验纠删码

Erasure Code是一种编码技术，它可以将n份原始数据，增加m份数据，并能通过n+m份中的任意n份数据，还原为原始数据, 即如果**有任意小于等于m份的数据失效，仍然能通过剩下的数据还原出来**, 简单的说就是**纠删码最多能容忍m个数据块被删除**.

HDFS、盘古等是多副本模式(比如3副本)，只要还有一个机器在，数据就不会丢失, 但这样磁盘的利用率其实挺低的，只有原始容量的1/3; minio使用的是erasure code, 磁盘利用率为n/(n+m), n为原始数据块, m为校验块. 与多副本相比, erasure code可认为是用cpu利用率节省磁盘空间.

基于纠删码的方法与多副本方法相比具有冗余度低、磁盘利用率高等优点，但计算、网络开销大，恢复效率低.

存储系统通常使用[RS(Reed Solomon)码](https://juejin.cn/post/6844903460928913421), 这里有一个golang的[reedsolomon](https://github.com/klauspost/reedsolomon).

> 阿里盘古使用`N+3`形式的纠删码

## checksum
checksum, 比如[高速HighwayHash(基于哈希的校验)](https://github.com/minio/highwayhash)可判别数据受硬件故障和静默数据损坏(也叫位衰减bit rot, 或数据腐化Data Rot, 或无声数据损坏Silent Data Corruption), 再结合erasure code/多副本机制, 可确保数据不损坏.

## 单机存储引擎
单机存储引擎是hash表, BTree等数据结构在HDD和SSD等持久化介质上的实现.

hash: 不支持顺序扫描 -> kv
BTree: 支持顺序扫描 -> 关系DB

LSM(log structure merge tree)存储引擎是采用批量转储技术来避免磁盘随机写入, 思想是将对数据的修改增量保持在内存中, 达到指定大小限制后将这些修改批量写入磁盘, 读取时需要合并磁盘中的历史数据和内存中最近的修改记录.

缓冲管理:
- LRU : 淘汰最长时间没有读/写的块
- LIRS : 分层LRU

    避免全表扫描时LRU被大量替换.

    实现: oracle db的touch count算法, mysql innodb中的替换算法

将内存中的数据定期转储(dump)到磁盘, 即为checkpoint(检查点)技术.

## 协议
gossip用于p2p系统中自治的节点协调对整个集群的认识, 比如集群的节点状态, 负载情况等.

## 现状
从amazon, facebook等公司的实践经验来看, dynamo及其开源实现Cassandra受到的关注在递减, 无中心节点的设计在当前难以成为主流, 毕竟中心节点更容易处理数据的一致性, 而且中心节点只维护少量的元数据, 一般不会成为性能瓶颈.