# ipv6
参考:
- [系统管理指南：IP 服务](https://docs.oracle.com/cd/E24847_01/html/819-7058/toc.html)

IPv6（IP version 6）是为了根本解决 IPv4 地址耗尽的问题而被标准化的网际协议. IPv6 的地址长度是16B(128 比特), 其特点:
- 性能提升. 包首部长度采用固定的值（40字节）, 不再采用首部检验码. 简化首部结构，减轻路由器负担. **路由器不再做分片处理**.
- 支持即插即用功能. 即使没有DHCP服务器也可以实现自动分配 IP 地址
- 采用认证与加密功能, 应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能
- 多播、Mobile IP 成为扩展功能

> IPv6 中最小 MTU 为 1280 字节, 因此，在嵌入式系统中对于那些有一定系统资源限制的设备来说，不需要进行"路径 MTU 发现"，而是在发送 IP 包时直接以 1280 字节为单位分片送出.

## 数据包
数据包= 报头(header:40B) + 扩展报头(extension header,可选,没有长度限制) + 上层协议数据单元(upper layer protocol data unit,比如ICMPv6,tcp或udp)

其中,`扩展报头+上层协议数据单元`称为`有效载荷`.

### 报头
![IPv6 Fixed Header](https://7n.w3cschool.cn/attachments/tuploads/ipv6/IPv6_header.jpg)

IPv6固定报头长度为40字节，8个字段,包含以下信息:
1. 版本(version:4b):表示Internet协议的版本，即0110=6
1. 通信流类别(traffic class:8b):这8位分为两部分。 最重要的6位用于服务类型，以便让路由器知道应该向该分组提供什么服务。 最低有效2位用于显式拥塞通知(ECN)
1. 流标签(flow label:20b):此标签用于维护属于通信的数据包的顺序流。 源标记序列以帮助路由器识别特定分组属于特定信息流。 此字段有助于避免数据包的重新排序。 它是为流媒体/实时媒体设计的。
       ipv6通过(流标签,源地址,目的地址)三元组可以唯一标识一条通信流.
       ipv4通过(源地址,目的地址,源端口, 目的端口, 传输层协议号)五元组可以唯一标识一条通信流.
1. 有效负载长度(payload length:16b):该字段用于告诉路由器特定分组在其有效载荷中包含多少信息。使用16位，可以指示高达65535个字节; 但是如果扩展报头包含逐跳扩展报头，则有效载荷可能超过65535字节，并且此字段设置为0。
1. 下一个报头(next head:8b): 定义了紧跟在header后面第一个扩展报头的类型,或者上层协议数据单元中的协议类型.
1. 跳跃限制(hot limit:8b): 定义了数据包所能经过的最大跳数. 这与IPv4中的TTL相同。 跳跃限制字段的值在它通过链路(路由器/跳跃)时递减1。 当字段达到0时，数据包被丢弃。
1. 源地址(source addr:128b): 发起方的地址
1. 目标地址(destination addr:128b):接收方的地址

> 在ipv6中, 中间路由器不再处理分端, 只由发起方处理, 节省了中间路由器的大量资源,比如cpu.
> ipv6没有校验和字段: 第2,4层都有校验和(udp校验和在ipv6中是必需的), 因此第3层校验和是冗余的.
> ipv4有选项字段,因此其报头长度可变;ipv6选项由扩展报头处理,因此长度固定.

### 扩展报头
![RFC 2460定义的必须支持的扩展报头](https://7n.w3cschool.cn/attachments/tuploads/ipv6/extension_headers.jpg)

1. 逐跳扩展头（Hop-by-Hop option）:代码是0。用来携带一些可选信息，数据包所经由的路径上的所有路由器**都必须**处理该可选信息。可选信息的结构包括可选数据类型、可选数据长度和可选数据3部分。RFC2460附录B介绍了如何定义可选数据结构。
1. 目标扩展头（Destination option）：代码是60。用来携带那些仅需要数据包目的地节点处理的可选信息。可选信息的结构包括可选数据类型、可选数据长度和可选数据3部分。
1. 路由扩展头（Routing）：代码是43。用来定义源路由。该扩展报头中的数据部分列出了一系列数据包到达目的地必须经由的节点地址。
1. 分段扩展头（Fragment）：代码是44。当发送方必须对超出MTU的数据进行分段时使用该扩展报头。扩展报头在每一个数据片段中都存在。
1. 认证扩展头（Authentication,AH）：代码时51。封装IPSec数据,定义和 IPv4 中相同, 提供报文验证, 完整行检查.
1. 封装安全有效载荷扩展头(Encapsulation Security Payload，ESP): 代码时50, 用于 IPSec，提供报文验证、完整性检查和加密。定义和 IPv4 中相同.

> [IPv4 和 IPv6 报头格式说明](https://ccie.lol/knowledge-base/ipv4-and-ipv6-packet-header/)

扩展报头的顺序:

![扩展报头的顺序](https://7n.w3cschool.cn/attachments/tuploads/ipv6/extension_headers_sequence.jpg)

上图中上标注释:
1. 应由第一个和后续目的地处理。
1. 应由最终目的地处理。

## ICMPv6
ICMPv6包有类型（Type:1B），代码（Code:1B），校验和（Checksum:2B）和消息体（Message Body）等几个字段,分类:
- 差错报文: 报告在转发ipv6数据包过程中出现的错误,比如(序号即为Type):

      1. 目的地不可达: 通知源地址，不能发送数据包
      2. 数据包太大: 通知源地址，数据包太大无法转发
      3. 超时: 通知源地址，IPv6数据包的“跃点限制”已过期
      4. 参数问题: 通知源地址，在处理 IPv6报头或 IPv6扩展报头时发生错误
- 信息报文: 提供诊断功能和附加的主机功能,比如组播侦听发现(MLD)和领节点发现(ND),比如:

      128. 回显请求: 用来确定 IPv6节点在网络上是否可用
      129. 回显应答: 对“回显请求”的应答
      133. 路由器请求: 对“路由器请求”的应答
      134. 路由器公告: 对“路由器公告”的应答

ND是icmpv6的功能, 用于确定相邻节点间的关系.

## 地址
地址格式定义在[RFC2373](https://ccie.lol/knowledge-base/rfc-2373-cn-ip-version-6-addressing-architecture/)中, 分3种:
- 首选格式: 冒分16进制法
- 压缩表示: 当地址中存在一个或多个连续的16为0时,允许用`::`缩短长度, 但一个ipv6**仅允许缩短一次**
- 内嵌ipv4地址格式: 过渡机制使用的一种特殊格式

参考:
- [RFC 2373 中文 – IPv6寻址体系结构](https://ccie.lol/knowledge-base/rfc-2373-cn-ip-version-6-addressing-architecture/)
- [常用的 IPv6 地址汇总](https://ccie.lol/knowledge-base/frequently-used-ipv6-address/)

### 地址前缀
表示方法: `地址/前缀长度`.

### 地址分类
1. 单播, 用来唯一标识一个接口
    1. 未指定地址: `::/128`
    1. 环回地址: `::1/128`
    1. 链路本地地址(link-local address), 指在同一个链路(类似ipv4的子网)内唯一的地址, 邻居发现过程要求使用该地址
           
           当一个节点启用ipv6协议栈时, 节点的每个接口始终会自动配置一个该类地址, 使得两个连接到同一链路的ipv6节点不需要做任何配置就可以通信. ipv6路由器永远不会将链路本地通信转发出该链路.
           其前缀是`FE80::/64`,即10b为`1111,1110,10`
           格式: 前缀 + 54b的`0` + 64b的接口id
    1. 站点本地地址(site-local address)

           类似ipv4的私有地址. 任何没有申请到提供商分配的可聚合全球单播地址的组织机构都可以使用该地址.
           前缀: `FEC0::/48`, 即10b为`1111,1110,11`
           格式: 前缀 + 38b的`0` + 16b的子网id + 64b的接口id
    1. 可聚合全球单播地址(aggregatable global unicast address), 即ipv6公网地址(全局范围内唯一)
    
           前缀: 3b的`001`
           格式: 前缀 + 45b是全局路由前缀(提供商分配) + 16b的子网ID + 64b的接口ID
     1. 内嵌ipv4地址的ipv6单播地址
       1. ipv4兼容地址: 80b的`0` + 16b的`0` + ipv4公网ip
       1. ipv4映射ipv6本地单播地址:  80b的`0` + 16b的`1` + ipv4私有ip, 用于局域网
       1. 6to4: 前缀 = `前缀2002::/16`+该节点的ipv4公网ip
1. 组播(`FF`+4b标志+4b作用域+112组id), 用来标识一组接口, 发送到组播地址的数据报文会被转发到该地址标识的所有接口
       前缀: 8b的`11111111`, 即前缀`FF`
       格式: 前缀 + 4b的标志 + 4b的作用域 + 112b的组id

       标志: 前3b固定为`0`, 最后一位: 0, 该组播地址由IANA永久指派, 公认的组播地址; 1, 临时组播地址
       作用域: 路由器可用来确定是否转发组播通信
       组id: 标识组播组, 且在作用域内唯一. 永久指派的组id独立于作用域; 临时组id仅与特定作用域有关
1. 任播(anycast), 用来标识一组接口
       格式: 64b子网前缀 + 64b的`0`
       任播地址从单播地址中分配而来, 仅看地址本身. 节点是无法区分任播地址和单播地址,因此节点必须使用明确的配置来指明任播地址. **目前其仅作为目标地址使用, 且仅分配给路由器**. 发送到任播地址的数据报文会被转发到该地址标识的一组接口中距离源节点最近(由路由协议度量)的一个接口

> ipv6的广播功能是由其组播完成.
> ipv6本地单播地址(类似ipv4的局域网地址) = 链路本地地址 + 站点本地地址

### 接口ID
常用`EUI-64`地址, 其通过在mac地址中间位置插入`FFFE`,并设置`U/L`位来生成.

> 全局/本地 (U/L):
>
> U/L 位是第一个字节的第七位，用于确定该地址是全局管理的还是本地管理的。如果将 U/L 位设置为 0，那么通过分配唯一的公司 ID，IEEE 已对地址进行了管理。如果 U/L 位被设置为 1，则地址是本地管理的。网络管理员已覆盖制造地址，并指定其他地址。

### 主机或路由器所拥有的ipv6地址
ipv6主机通常在逻辑上是多主机的, 因为它们至少有两个用于接收数据包的地址: 链路本地地址 + 站点本地地址/全局单播地址

ipv6主机上可指派的单播地址:
- 链路本地地址
- 站点本地地址或至少一个全局单播地址
- 回环地址`::1`

ipv6主机上可监听的组播地址:
- 作用域为"节点本地"的所有节点组播地址`FF01::1`
- 作用域为"链路本地"的所有节点组播地址`FF02::1`
- 每个接口上用于每个单播地址请求的节点地址
- 每个接口上已加入组的组播地址

ipv6路由器上可指派的单播地址:
- 链路本地地址
- 站点本地地址或至少一个全局单播地址
- 回环地址`::1`

ipv6路由器主机上可指派的任播地址:
- 用于每个子网的子网路由器任播地址
- 其他任播地址(可选)

ipv6路由器上可监听的组播地址:
- 作用域为"节点本地"的所有节点组播地址`FF01::1`
- 作用域为"节点本地"的所有路由器地址`FF01::2`
- 作用域为"链路本地"的所有节点组播地址`FF02::1`
- 作用域为"链路本地"的所有路由器组播地址`FF02::2`
- 作用域为"站点本地"的所有路由器组播地址`FF05::2`
- 每个接口上用于每个单播地址的请求节点地址
- 每个接口上已加入组的组播地址

> 站点本地地址与全局单播地址是互斥的

### ipv6地址自动配置
参考:
- [下一代IP协议-IPv6地址分配原理](https://cloud.tencent.com/developer/news/311715)

IPv6 的一个主要特征就是允许主机自动配置接口. 通过相邻节点搜索，主机可以在本地链路上查找 IPv6 路由器并请求站点前缀. 在自动配置过程中，主机将执行以下操作：
1. 为每个接口创建链路本地地址，该操作不要求链路上有路由器
1. 检验地址在链路上是否唯一，该操作不要求链路上有路由器
1. 确定全局地址是应通过无状态机制、有状态机制还是这两种机制来获取（要求链路上有路由器）

具体方法
1. 无状态的自动配置 : 基于路由器公告消息的接收. 缺点: 可管理性差
       网络接口接收路由器宣告的全局地址前缀，再结合接口ID得到一个可聚集全局单播地址
1. IPv6动态主机配置协议
       IPv6动态主机配置协议DHCPv6是由IPv4场景下的DHCP发展而来. 客户端通过向DHCP服务器发出申请来获取本机IP地址并进行自动配置，DHCP服务器负责管理并维护地址池以及地址与客户端的映射信息

> 请不要使用无状态自动配置功能来创建服务器的 IPv6 地址. 主机会在自动配置过程中基于特定于硬件的信息来自动生成接口 ID. 如果用新接口替换现有的接口，当前的接口 ID 可能会变得无效.