# zab
Multi-Paxos 解决的是一系列值如何达成共识的问题，它关心的是，对于指定序号的位置，最多只有一个指令（Command）会被选定，但它不关心选定的是哪个指令，也就是说，它不关心指令的顺序性（也就是操作的顺序性）, 即它不关心最终达成共识的值是什么，不关心各值的顺序.

ZAB 协议的最核心设计目标是如何实现操作的顺序性.

> Multi-Paxos 无法实现操作的顺序性，但 Raft 可以. 但zab早于raft.

ZAB 不是共识算法，不基于状态机，而是基于主备模式的原子广播协议，最终实现了操作的顺序性.

主备，就是 Master-Slave 模型，一个主节点和多个备份节点，所有副本的数据都以主节点为准，主节点采用二阶段提交，向备份节点同步数据，如果主节点发生故障，数据最完备的节点将当选主节点。而原子广播协议，可以理解成广播一组消息，消息的顺序是固定的.

ZAB 做了个优化，为了实现分区容错能力，将数据复制到大多数节点后（也就是如果大多数节点准备好了），领导者就会进入提交执行阶段，通知备份节点执行提交操作。在这一点上，Raft 和 ZAB 是类似的.

> 状态机指的是有限状态机，它是一个数学模型. 它用来处理一系列请求，最大的特点就是确定性，也就是说，对于相同的输入，不管重复运行多少次，最终的内部状态和输出都是相同的.

zab实现操作的顺序性:
1. ZAB 实现了主备模式，也就是所有的数据都以主节点为准
1. ZAB 实现了 FIFO 队列，保证消息处理的顺序性
1. ZAB 还实现了当主节点崩溃后，只有日志最完备的节点才能当选主节点，因为日志最完备的节点包含了所有已经提交的日志，所以这样就能保证提交的日志不会再改变

ZAB 是通过“一切以领导者为准”的强领导者模型和严格按照顺序提交日志，来实现操作的顺序性的，这一点和 Raft 是一样的.

## FAQ
### 共识算法需要状态机的原因
Multi-Paxos、Raft 都是共识算法，而共识算法是就一系列值达成共识的，达成共识后，这个值就不能改了。但有时候是需要更改数据的值的，比如 KV 存储，此时通过提议新的指令，达成共识后，提交给状态机执行，来达到修改指定内容的效果，比如修改 KV 存储中指定 key 对应的值.