# QuorumNWR
最终一致性和强一致性的区别:
1. 强一致性能保证写操作完成后，任何后续访问都能读到更新后的值
1. 最终一致性只能保证如果对某个对象没有新的写操作了，最终所有后续访问都能读到相同的最近更新的值。也就是说，写操作完成后，后续访问可能会读到旧数据

在 AP 型分布式系统中（比如 Dynamo、Cassandra、InfluxDB 企业版的 DATA 节点集群），Quorum NWR 是通常都会实现的一个功能. 通过 Quorum NWR, 可以自定义一致性级别，通过临时调整写入或者查询的方式，当 W + R > N 时，就可以实现强一致性了.

Quorum NWR 的三要素:
- N 表示副本数，又叫做复制因子（Replication Factor）. 也就是说，N 表示集群中同一份数据有多少个副本

	副本数可以不等于节点数，不同的数据可以有不同的副本数.
- W，又称写一致性级别（Write Consistency Level），表示成功完成 W 个副本更新，才完成写操作
- R，又称读一致性级别（Read Consistency Level），表示读取一个数据对象时需要读 R 个副本。即读取指定数据时，要读 R 副本，然后返回 R 个副本中最新的那份数据

N、W、R 值的不同组合，会产生不同的一致性效果，具体来说，有这么两种效果：
1. 当 W + R > N 的时候，对于客户端来讲，整个系统能保证强一致性，一定能返回更新后的那份数据
1. 当 W + R < N 的时候，对于客户端来讲，整个系统只能保证最终一致性，可能会返回旧数据

另外，如何设置 N、W、R 值，取决于我们想优化哪方面的性能。比如，N 决定了副本的冗余备份能力；如果设置 W = N，读性能比较好；如果设置 R = N，写性能比较好；如果设置 W = (N + 1) / 2、R = (N + 1) / 2，容错能力比较好，能容忍少数节点（也就是 (N - 1) / 2）的故障。

Quorum NWR 是非常实用的一个算法，能有效弥补 AP 型系统缺乏强一致性的痛点，给业务提供了按需选择一致性级别的灵活度，建议实现 AP 型系统时，也实现 Quorum NWR.

以InfluxDB 企业版举例:
1. 在创建保留策略时，设置指定数据库（Database）对应的副本数：`create retention policy “rp_one_day” on “telegraf” duration 1d replication 3`, 通过 replication 参数，指定了数据库 telegraf 对应的副本数为 3

	在 InfluxDB 企业版中，副本数不能超过节点数据, 因为多副本的意义在于冗余备份，如果副本数超过节点数，就意味着在一个节点上会存在多个副本，那么这时冗余备份的意义就不大了. 比如机器故障时，节点上的多个副本是同时被影响的.

InfluxDB 企业版，支持“any、one、quorum、all”4 种写一致性级别，具体的含义是这样的:
- any：任何一个节点写入成功后，或者接收节点已将数据写入 Hinted-handoff 缓存（也就是写其他节点失败后，本地节点上缓存写失败数据的队列）后，就会返回成功给客户端
- one：任何一个节点写入成功后，立即返回成功给客户端，不包括成功写入到 Hinted-handoff 缓存
- quorum：当大多数节点写入成功后，就会返回成功给客户端。此选项仅在副本数大于 2 时才有意义，否则等效于 all
- all：仅在所有节点都写入成功后，返回成功

对时序数据库而言，读操作常会拉取大量数据，查询性能是挑战，是必须要考虑优化的，因此，在 InfluxDB 企业版中，不支持读一致性级别，只支持写一致性级别。另外，可以通过设置写一致性级别为 all，来实现强一致性.

如果像 InfluxDB 企业版这样，实现了 Quorum NWR，那么在业务临时需要实现强一致性时，就可以通过设置写一致性级别为 all，来实现了.